#!/bin/bash

set -e  # å‡ºé”™å³é€€å‡º
echo "ğŸš€ å¼€å§‹æ›´æ–° tuopu é¡¹ç›®..."

# 1. æ‹‰å–ä»£ç 
echo "ğŸ“¦ æ‹‰å–æœ€æ–°ä»£ç ..."
cd /usr/local/www/tuopu-docker/tuopu
pull_result=$(git pull)
echo "$pull_result"

# 2. å›åˆ° docker æ ¹ç›®å½•
cd /usr/local/www/tuopu-docker

# è·å–å®¹å™¨çŠ¶æ€
tuopu_status=$(docker inspect -f '{{.State.Status}}' tuopu 2>/dev/null || echo "not_found")
tuopu2_status=$(docker inspect -f '{{.State.Status}}' tuopu2 2>/dev/null || echo "not_found")

echo "å½“å‰å®¹å™¨çŠ¶æ€ï¼štuopu=$tuopu_status, tuopu2=$tuopu2_status"

# è®¾ç½®æ„å»ºå†³ç­–é€»è¾‘
UP_FLAGS="-d"
if [[ "$pull_result" == *"Already up to date"* ]]; then
    echo "âœ… ä»£ç å·²ç»æ˜¯æœ€æ–°ï¼Œå°†è·³è¿‡ Maven ç¼–è¯‘(builder)å¹¶ç›´æ¥å¯åŠ¨ç°æœ‰é•œåƒã€‚"
else
    echo "ğŸ”§ æ£€æµ‹åˆ°ä»£ç æ›´æ–°ï¼Œæ­£åœ¨æ‰§è¡Œ builder å®¹å™¨è¿›è¡Œæ‰“åŒ…..."
    docker-compose run --rm builder
    UP_FLAGS="--build -d"
fi

# å¯åŠ¨ç›®æ ‡å®¹å™¨ï¼Œå¹¶å¥åº·æ£€æŸ¥æˆåŠŸåå†åœæ­¢æ—§å®¹å™¨
if [[ "$tuopu_status" == "running" ]]; then
  echo "ğŸ” tuopu æ­£åœ¨è¿è¡Œï¼Œå‡†å¤‡åˆ‡æ¢åˆ° tuopu2"

  docker-compose stop tuopu2 || true
  docker-compose rm -f tuopu2 || true

  echo "ğŸš€ å¯åŠ¨ tuopu2..."
  docker-compose up $UP_FLAGS tuopu2

  echo "ğŸ©º æ£€æŸ¥ tuopu2 å¥åº·çŠ¶æ€..."
  HEALTH_URL="http://127.0.0.1:8082/tuopu/ops/healthCheck"

  set +e
  for i in {1..100}; do
      response=$(curl -s --location --request GET "$HEALTH_URL" || true)
      code=$(echo "$response" | grep -o '"code":[[:space:]]*200')
      echo "$code"
      if [[ -n "$code" ]]; then
	  echo "ğŸ”„ æ›´æ–° Nginx è·¯ç”±åˆ° tuopu..."
          echo "proxy_pass http://127.0.0.1:8082/tuopu/;" > /usr/local/nginx/conf/active_tuopu.conf

          echo "ğŸ” é‡è½½ Nginx é…ç½®..."
          nginx -s reload
          
	  response=$(curl -s --location --request GET "http://127.0.0.1:80/tuopu/ops/healthCheck" || true)
          code=$(echo "$response" | grep -o '"code":[[:space:]]*200')
          echo "$code"

          if [[ -n "$code" ]]; then
            echo "âœ… tuopu2 æœåŠ¡å·²å¥åº·å¯åŠ¨ï¼Œå‡†å¤‡åœæ­¢æ—§å®¹å™¨ tuopuï¼ˆç­‰å¾… 60 ç§’ä»¥å®Œæˆä»»åŠ¡ï¼‰"
    	    sleep 60
    	    echo "â›”ï¸ åœæ­¢ tuopu å®¹å™¨..."
	    docker-compose stop tuopu
            docker-compose rm -f tuopu
	  fi
	  break
      fi
      echo "â³ ç¬¬ $i æ¬¡å¥åº·æ£€æŸ¥æœªé€šè¿‡ï¼Œ3 ç§’åé‡è¯•..."
      sleep 3
  done
  set -e

  if [[ -z "$code" ]]; then
      echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼štuopu2 æœªæˆåŠŸå¯åŠ¨ï¼"
      exit 1
  fi

elif [[ "$tuopu2_status" == "running" ]]; then
  echo "ğŸ” tuopu2 æ­£åœ¨è¿è¡Œï¼Œå‡†å¤‡åˆ‡æ¢åˆ° tuopu"

  docker-compose stop tuopu || true
  docker-compose rm -f tuopu || true

  echo "ğŸš€ å¯åŠ¨ tuopu..."
  docker-compose up $UP_FLAGS tuopu

  echo "ğŸ©º æ£€æŸ¥ tuopu å¥åº·çŠ¶æ€..."
  HEALTH_URL="http://127.0.0.1:8081/tuopu/ops/healthCheck"

  set +e
  for i in {1..100}; do
      response=$(curl -s --location --request GET "$HEALTH_URL" || true)
      code=$(echo "$response" | grep -o '"code":[[:space:]]*200')
      echo "$code"
      if [[ -n "$code" ]]; then
          echo "ğŸ”„ æ›´æ–° Nginx è·¯ç”±åˆ° tuopu..."
	  echo "proxy_pass http://127.0.0.1:8081/tuopu/;" > /usr/local/nginx/conf/active_tuopu.conf
	  
	  echo "ğŸ” é‡è½½ Nginx é…ç½®..."
	  nginx -s reload
	  
          response=$(curl -s --location --request GET "http://127.0.0.1:80/tuopu/ops/healthCheck" || true)
          code=$(echo "$response" | grep -o '"code":[[:space:]]*200')
          echo "$code"
          
	  if [[ -n "$code" ]]; then
            echo "âœ… tuopu æœåŠ¡å·²å¥åº·å¯åŠ¨ï¼Œå‡†å¤‡åœæ­¢æ—§å®¹å™¨ tuopu2ï¼ˆç­‰å¾… 60 ç§’ä»¥å®Œæˆä»»åŠ¡ï¼‰"
            sleep 60
            echo "â›”ï¸ åœæ­¢ tuopu2 å®¹å™¨..."
	    docker-compose stop tuopu2 || true
            docker-compose rm -f tuopu2 || true
	  fi
          break
      fi
      echo "â³ ç¬¬ $i æ¬¡å¥åº·æ£€æŸ¥æœªé€šè¿‡ï¼Œ3 ç§’åé‡è¯•..."
      sleep 3
  done
  set -e

  if [[ -z "$code" ]]; then
      echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼štuopu æœªæˆåŠŸå¯åŠ¨ï¼"
      exit 1
  fi

else
  echo "âš ï¸ æ²¡æœ‰å®¹å™¨åœ¨è¿è¡Œï¼Œé»˜è®¤å¯åŠ¨ tuopu"
  docker-compose up $UP_FLAGS tuopu
fi

# æ¸…ç†æ— ç”¨çš„ Docker é•œåƒ
echo "ğŸ§¹ æ¸…ç†æ— ç”¨çš„ Docker é•œåƒ..."
docker image prune -f

echo "âœ… æ›´æ–°å®Œæˆï¼"
