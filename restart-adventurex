#!/bin/bash

set -e  # å‡ºé”™å³é€€å‡º
echo "ğŸš€ å¼€å§‹æ›´æ–° adventurex é¡¹ç›®..."

# 1. æ‹‰å–ä»£ç 
echo "ğŸ“¦ æ‹‰å–æœ€æ–°ä»£ç ..."
cd /usr/local/www/adventurex-docker/adventurex
pull_result=$(git pull)
echo "$pull_result"

# 2. å›åˆ° docker æ ¹ç›®å½•
cd /usr/local/www/adventurex-docker

# è·å–å®¹å™¨çŠ¶æ€
adventurex_status=$(docker inspect -f '{{.State.Status}}' adventurex 2>/dev/null || echo "not_found")
adventurex2_status=$(docker inspect -f '{{.State.Status}}' adventurex2 2>/dev/null || echo "not_found")

echo "å½“å‰å®¹å™¨çŠ¶æ€ï¼šadventurex=$adventurex_status, adventurex2=$adventurex2_status"

# ç¼–è¯‘æ„å»º,builderæ”¾åˆ°ä»£ç æœ‰æ›´æ–°çš„é€»è¾‘é‡Œ
#echo "ğŸ”§ æ‰§è¡Œ builder æ„å»º..."
#docker-compose run --rm builder

# 3. è®¾ç½®æ„å»ºå†³ç­–é€»è¾‘
UP_FLAGS="-d"
if [[ "$pull_result" == *"Already up to date"* ]]; then
    echo "âœ… ä»£ç å·²ç»æ˜¯æœ€æ–°ï¼Œå°†è·³è¿‡ Maven ç¼–è¯‘(builder)å¹¶ç›´æ¥å¯åŠ¨ç°æœ‰é•œåƒã€‚"
else
    echo "ğŸ”§ æ£€æµ‹åˆ°ä»£ç æ›´æ–°ï¼Œæ­£åœ¨æ‰§è¡Œ builder å®¹å™¨è¿›è¡Œæ‰“åŒ…..."
    # åªæœ‰ä»£ç å˜äº†æ‰è¿è¡Œè¿™ä¸ªä¸´æ—¶å®¹å™¨äº§å‡ºæ–°çš„ .jar
    docker-compose run --rm builder
    # æ ‡è®°åç»­å¯åŠ¨æ—¶éœ€è¦é€šè¿‡ Dockerfile é‡æ–°å°è£…é•œåƒ
    UP_FLAGS="--build -d"
fi

# å¯åŠ¨ç›®æ ‡å®¹å™¨ï¼Œå¹¶å¥åº·æ£€æŸ¥æˆåŠŸåå†åœæ­¢æ—§å®¹å™¨
if [[ "$adventurex_status" == "running" ]]; then
  echo "ğŸ” adventurex æ­£åœ¨è¿è¡Œï¼Œå‡†å¤‡åˆ‡æ¢åˆ° adventurex2"

  docker-compose stop adventurex2 || true
  docker-compose rm -f adventurex2 || true

  echo "ğŸš€ å¯åŠ¨ adventurex2..."
  docker-compose up $UP_FLAGS adventurex2

  echo "ğŸ©º æ£€æŸ¥ adventurex2 å¥åº·çŠ¶æ€..."
  HEALTH_URL="http://127.0.0.1:8084/adventurex/ops/healthCheck"

  set +e
  for i in {1..100}; do
      response=$(curl -s --location --request GET "$HEALTH_URL" || true)
      code=$(echo "$response" | grep -o '"code":[[:space:]]*200')
      echo "$code"
      if [[ -n "$code" ]]; then
	  echo "ğŸ”„ æ›´æ–° Nginx è·¯ç”±åˆ° adventurex..."
          echo "set \$backend_host 127.0.0.1:8084;" > /usr/local/nginx/conf/active_adventurex.conf

          echo "ğŸ” é‡è½½ Nginx é…ç½®..."
          nginx -s reload
          
	  response=$(curl -s --location --request GET "http://127.0.0.1:81/adventurex/ops/healthCheck" || true)
          code=$(echo "$response" | grep -o '"code":[[:space:]]*200')
          echo "$code"

          if [[ -n "$code" ]]; then
            echo "âœ… adventurex2 æœåŠ¡å·²å¥åº·å¯åŠ¨ï¼Œå‡†å¤‡åœæ­¢æ—§å®¹å™¨ adventurexï¼ˆç­‰å¾… 60 ç§’ä»¥å®Œæˆä»»åŠ¡ï¼‰"
    	    sleep 60
    	    echo "â›”ï¸ åœæ­¢ adventurex å®¹å™¨..."
	    docker-compose stop adventurex
            docker-compose rm -f adventurex
	  fi
	  break
      fi
      echo "â³ ç¬¬ $i æ¬¡å¥åº·æ£€æŸ¥æœªé€šè¿‡ï¼Œ3 ç§’åé‡è¯•..."
      sleep 3
  done
  set -e

  if [[ -z "$code" ]]; then
      echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼šadventurex2 æœªæˆåŠŸå¯åŠ¨ï¼"
      exit 1
  fi

elif [[ "$adventurex2_status" == "running" ]]; then
  echo "ğŸ” adventurex2 æ­£åœ¨è¿è¡Œï¼Œå‡†å¤‡åˆ‡æ¢åˆ° adventurex"

  docker-compose stop adventurex || true
  docker-compose rm -f adventurex || true

  echo "ğŸš€ å¯åŠ¨ adventurex..."
  docker-compose up $UP_FLAGS adventurex

  echo "ğŸ©º æ£€æŸ¥ adventurex å¥åº·çŠ¶æ€..."
  HEALTH_URL="http://127.0.0.1:8083/adventurex/ops/healthCheck"

  set +e
  for i in {1..100}; do
      response=$(curl -s --location --request GET "$HEALTH_URL" || true)
      code=$(echo "$response" | grep -o '"code":[[:space:]]*200')
      echo "$code"
      if [[ -n "$code" ]]; then
          echo "ğŸ”„ æ›´æ–° Nginx è·¯ç”±åˆ° adventurex..."
	  echo "set \$backend_host 127.0.0.1:8083;" > /usr/local/nginx/conf/active_adventurex.conf
	  
	  echo "ğŸ” é‡è½½ Nginx é…ç½®..."
	  nginx -s reload
	  
          response=$(curl -s --location --request GET "http://127.0.0.1:81/adventurex/ops/healthCheck" || true)
          code=$(echo "$response" | grep -o '"code":[[:space:]]*200')
          echo "$code"
          
	  if [[ -n "$code" ]]; then
            echo "âœ… adventurex æœåŠ¡å·²å¥åº·å¯åŠ¨ï¼Œå‡†å¤‡åœæ­¢æ—§å®¹å™¨ adventurex2ï¼ˆç­‰å¾… 60 ç§’ä»¥å®Œæˆä»»åŠ¡ï¼‰"
            sleep 60
            echo "â›”ï¸ åœæ­¢ adventurex2 å®¹å™¨..."
	    docker-compose stop adventurex2 || true
            docker-compose rm -f adventurex2 || true
	  fi
          break
      fi
      echo "â³ ç¬¬ $i æ¬¡å¥åº·æ£€æŸ¥æœªé€šè¿‡ï¼Œ3 ç§’åé‡è¯•..."
      sleep 3
  done
  set -e

  if [[ -z "$code" ]]; then
      echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼šadventurex æœªæˆåŠŸå¯åŠ¨ï¼"
      exit 1
  fi

else
  echo "âš ï¸ æ²¡æœ‰å®¹å™¨åœ¨è¿è¡Œï¼Œé»˜è®¤å¯åŠ¨ adventurex"
  docker-compose up $UP_FLAGS adventurex
fi

# æ¸…ç†æ— ç”¨çš„ Docker é•œåƒ
echo "ğŸ§¹ æ¸…ç†æ— ç”¨çš„ Docker é•œåƒ..."
docker image prune -f

echo "âœ… æ›´æ–°å®Œæˆï¼"
